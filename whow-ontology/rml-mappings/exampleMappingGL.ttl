@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix l0: <https://w3id.org/italia/onto/l0/> .
@prefix iot: <https://w3id.org/italia/onto/IoT/> .
@prefix mu: <https://w3id.org/italia/onto/MU/> .
@prefix ti: <https://w3id.org/italia/onto/TI/> .
@prefix cov: <https://w3id.org/italia/onto/COV/> .
@prefix clv: <https://w3id.org/italia/onto/CLV/> .
@prefix indicator: <https://w3id.org/italia/onto/Indicator/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix rml: <http://semweb.mmlab.be/ns/rml#> .
@prefix ql: <http://semweb.mmlab.be/ns/ql#>.
@prefix fnml: <http://semweb.mmlab.be/ns/fnml#> .
@prefix grel: <http://users.ugent.be/~bjdmeest/function/grel.ttl#> .
@prefix fno: <https://w3id.org/function/ontology#> .
@prefix idlab-fn: <http://example.com/idlab/function/> .
@prefix sd: <http://www.w3.org/ns/sparql-service-description#> .
@base <https://dati.lombardia.it/loddata/> .

##########################################################
## LOGICAL SOURCES TO BE USED
##########################################################

# #LogicalSourceQA
<#LogicalSourceQA> a rml:BaseSource ;
    rml:source [
      a csvw:Table;
      csvw:url "QUALITA_ACQUE_SOTTERRANEE.csv";
      csvw:dialect [
        a csvw:Dialect;
        csvw:delimiter ","
      ]
    ];
    rml:referenceFormulation ql:CSV .


##Logical Source PROVINCE RDF
<#InputSPARQL>
    a sd:Service ;
    sd:endpoint <https://ontopia-virtuoso.agid.gov.it/sparql> ;
    sd:supportedLanguage sd:SPARQL11Query ;
    sd:resultFormat <http://www.w3.org/ns/formats/SPARQL_Results_JSON> .

<#LogicalSourcePROVINCERDF> a rml:BaseSource ;
     rml:source <#InputSPARQL>;
     rml:referenceFormulation ql:JSONPath;
     rml:iterator "$.results.bindings[*]";
     rml:query """
     PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
     PREFIX clv: <https://w3id.org/italia/onto/CLV/>

     SELECT ?s ?provincia ?ID
     WHERE { ?s a skos:Concept ;
          skos:inScheme <https://w3id.org/italia/controlled-vocabulary/territorial-classifications/provinces> ;
          skos:notation ?ID ;
          clv:acronym ?provincia .

     } """
.

##Logical Source CITY RDF
<#LogicalSourceCITYRDF> a rml:BaseSource ;
      rml:source <#InputSPARQL>;
      rml:referenceFormulation ql:JSONPath;
      rml:iterator "$.results.bindings[*]";
      rml:query """
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX clv: <https://w3id.org/italia/onto/CLV/>
PREFIX ti: <https://w3id.org/italia/onto/TI/>
SELECT ?s ?ID ?nome ?starttime ?endTime
WHERE { ?s a skos:Concept ;
        skos:inScheme <https://w3id.org/italia/controlled-vocabulary/territorial-classifications/cities> ;
        skos:notation ?ID ;
        skos:prefLabel ?nome ;
        clv:hasSOValidity/ti:endTime ?endTime ;
        clv:hasSOValidity/ti:startTime ?starttime ;
        clv:hasHigherRank <https://w3id.org/italia/controlled-vocabulary/territorial-classifications/regions/03> .
        FILTER (str(?endTime)="9999-12-31")

}
 """
      .


###########################################################
##                  MAPPING RULES
##########################################################


########################################################
## Observation mapping
########################################################
<#QAObservationMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;

rr:subjectMap [
  fnml:functionValue [
     rr:predicateObjectMap [
       rr:predicate fno:executes ;
       rr:objectMap [ rr:constant grel:array_join ]
     ];

      rr:predicateObjectMap [
        rr:predicate grel:p_array_a ;
        rr:objectMap [ rr:constant "https://dati.lombardia.it/loddata/observation"]
      ] ;

      rr:predicateObjectMap [
            rr:predicate grel:p_array_a ;
            rr:objectMap [
                fnml:functionValue [
                    rr:predicateObjectMap [
                        rr:predicate fno:executes ;
                        rr:objectMap [ rr:constant idlab-fn:random ]
                    ]
				        ]
           ]
      ];
      rr:predicateObjectMap [
        rr:predicate grel:p_string_sep ;
        rr:objectMap [ rr:constant "/" ]
      ]
    ] ; rr:class iot:Observation
];
rr:predicateObjectMap [
  rr:predicate rdfs:label;
  rr:objectMap [ rr:template "Osservazione del Dipartimento {DIPARTIMENTO} su {NOME_STANDARD} in data {DataCampionamento}" ; rr:language "it" ]
] ;
rr:predicateObjectMap [
  rr:predicate iot:hasFeatureOfInterest;
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata/feature-of-interest/ground-water" ; rr:termType rr:IRI ]
] ;
rr:predicateObjectMap [
  rr:predicate iot:hasObservationParameter;
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata//observation-parameter/{CAS}" ; rr:termType rr:IRI ]
] ;
rr:predicateObjectMap [
  rr:predicate iot:hasObservationValue;
  #rr:objectMap [ rr:parentTriplesMap <#ObservationValueMapping> ]
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata//observation-value/{VALORE_NORMALIZZATO}" ; rr:termType rr:IRI ]
] ;
rr:predicateObjectMap [
  rr:predicate clv:hasGeometry;
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata/geometry/({WGS84_Y})-({WGS84_X})" ; rr:termType rr:IRI ]
] ;
rr:predicateObjectMap [
  rr:predicate iot:madeBySensor;
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata/sensor/{CODICE_PP}" ; rr:termType rr:IRI ]
] ;
rr:predicateObjectMap [
  rr:predicate iot:generationTime;
  rr:objectMap <#generationTimeMapping>
] .


# #################################
# ## FEATURE OF INTEREST  MAPPING
# #################################
<#FeatureOfInterestMapping>  a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata/feature-of-interest/ground-water";
  rr:class iot:FeatureOfInterest
] ;
rr:predicateObjectMap [
  rr:predicate l0:name;
  rr:objectMap [ rr:constant "Acque sottorranee" ; rr:language "it"]
] .


# #################################
# ## OBSERVATION PARAMETER MAPPING
# #################################
<#ObservationParameterMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata//observation-parameter/{CAS}";
  rr:class iot:ObservationParameter
] ;
rr:predicateObjectMap [
  rr:predicate l0:name;
  rr:objectMap [ rml:reference "NOME_STANDARD" ; rr:language "it"]
] ;
rr:predicateObjectMap [
  rr:predicate iot:hasValueForObservationParameter;
  #rr:objectMap [ rr:parentTriplesMap <#ObservationParamValueMapping> ]
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata//observation-parameter-value/{VALORE_NORMALIZZATO}" ; rr:termType rr:IRI ]
] .

########################################
## OBSERVATION PARAMENTER VALUE MAPPING
########################################
<#ObservationParamValueMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata//observation-parameter-value/{VALORE_NORMALIZZATO}";
  rr:class iot:ObservationValue , mu:Value
] ;
rr:predicateObjectMap [
  rr:predicate mu:value;
  rr:objectMap [ rml:reference "VALORE_NORMALIZZATO" ]
] ;
rr:predicateObjectMap [
  rr:predicate mu:hasMeasurementUnit;
  #rr:objectMap [ rr:parentTriplesMap <#MeasurementUnitMapping> ]
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata/measurement-unit/{UM}" ; rr:termType rr:IRI ]
] .

####################################
## OBSERVATION VALUE MAPPING
####################################
<#ObservationValueMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata//observation-value/{VALORE_NORMALIZZATO}";
  rr:class iot:ObservationValue , mu:Value
] ;
rr:predicateObjectMap [
  rr:predicate mu:value;
  rr:objectMap [ rml:reference "VALORE_NORMALIZZATO" ; rr:datatype xsd:decimal ]
] ;
rr:predicateObjectMap [
  rr:predicate mu:hasMeasurementUnit;
  #rr:objectMap [ rr:parentTriplesMap <#MeasurementUnitMapping> ]
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata/measurement-unit/{UM}" ; rr:termType rr:IRI ]
] .

###################################
## MEASUREMENT UNIT MAPPING
####################################
<#MeasurementUnitMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata/measurement-unit/{UM}";
  rr:class mu:MeasurmentUnit
] ;
rr:predicateObjectMap [
  rr:predicate l0:name;
  rr:objectMap [ rml:reference "UM" ]
] .

###################################
## GEOMETRY MAPPING
###################################
<#GeometryMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata/geometry/({WGS84_Y})-({WGS84_X})";
  rr:class clv:Geometry
] ;
rr:predicateObjectMap [
  rr:predicate clv:hasGeometryType;
  rr:objectMap [ rr:template "https://w3id.org/italia/onto/CLV/Point"; rr:termType rr:IRI; ]
] ;
rr:predicateObjectMap [
  rr:predicate rdfs:label;
  rr:objectMap [ rr:template "Geometria {location}" ; rr:language "it" ]
] ;
rr:predicateObjectMap [
  rr:predicate clv:coordinateSystem;
  rr:objectMap [ rr:constant "WGS84" ]
] ;
rr:predicateObjectMap [
  rr:predicate clv:lat;
  rr:objectMap [ rml:reference "WGS84_Y" ]
] ;
rr:predicateObjectMap [
  rr:predicate clv:long;
  rr:objectMap [ rml:reference "WGS84_X" ]
] .

########################
## SENSOR MAPPING
########################
<#SensorMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata/sensor/{CODICE_PP}";
  rr:class iot:Sensor
] ;
rr:predicateObjectMap [
  rr:predicate l0:identifier;
  rr:objectMap [ rml:reference "CODICE_PP" ]
] ;
rr:predicateObjectMap [
  rr:predicate rdfs:label;
  rr:objectMap [ rr:template "Sensore {CODICE_PP}" ; rr:language "it" ]
] ;
rr:predicateObjectMap [
  rr:predicate iot:isHostedByPlatform;
  rr:objectMap [ rr:template "https://dati.lombardia.it/loddata/platform/{CODICE_PP}" ; rr:termType rr:IRI ]
] .

#########################
## PLATFORM MAPPING
#########################
<#PlatformMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
  rr:template "https://dati.lombardia.it/loddata/platform/{CODICE_PP}";
  rr:class iot:Platform
] ;
rr:predicateObjectMap [
  rr:predicate rdfs:label;
  rr:objectMap [ rr:template "Piattaforma del {DIPARTIMENTO}" ; rr:language "it" ]
] ;
rr:predicateObjectMap [
  rr:predicate l0:name;
  rr:objectMap [ rml:reference "DIPARTIMENTO" ; rr:language "it" ]
] ;
rr:predicateObjectMap [
  rr:predicate l0:identifier;
  rr:objectMap [ rml:reference "CODICE_PP" ]
] ;
rr:predicateObjectMap [
  rr:predicate clv:hasSpatialCoverage;
  rr:objectMap [
     rr:parentTriplesMap <#ProvinceMapping> ;
     rr:joinCondition [
        rr:child "PROVINCIA";
        rr:parent "provincia.value" ;
     ] ;
  ] ;
] ;
rr:predicateObjectMap [
  rr:predicate clv:hasSpatialCoverage;
  rr:objectMap [
     rr:parentTriplesMap <#CityMapping> ;
     rr:joinCondition [
        rr:child "COMUNE";
        rr:parent "nome.value" ;
     ] ;
  ] ;
] .

##############################
## PROVINCE LINKING
##############################

<#ProvinceMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourcePROVINCERDF> ;
rr:subjectMap [
  rr:template "https://w3id.org/italia/controlled-vocabulary/territorial-classifications/provinces/{ID.value}" ;  rr:termType rr:IRI ;
].

##############################
## CITY LINKING
##############################

<#CityMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceCITYRDF> ;
rr:subjectMap [
  rr:template "https://w3id.org/italia/controlled-vocabulary/territorial-classifications/cities/{ID.value}-({starttime.value})" ;  rr:termType rr:IRI ;
].

##################################
## GENERATION TIME OBJECT MAPPING
##################################
<#generationTimeObjMapping> a rr:TriplesMap ;
rml:logicalSource <#LogicalSourceQA> ;
rr:subjectMap [
fnml:functionValue [
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:array_join ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  [ rr:constant "https://dati.lombardia.it/loddata/time-interval"]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#formatDate>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_string_sep ;
    rr:objectMap [ rr:constant "/" ]
  ];
]; rr:class ti:TimeInterval

] ;
rr:predicateObjectMap [
  rr:predicate ti:date ;
  rr:objectMap  <#formatDateMapping>
].



##############################
## GENERATION TIME URI MAPPING
##############################
<#generationTimeMapping>
rr:termType rr:IRI ;
fnml:functionValue [
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:array_join ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  [ rr:constant "https://dati.lombardia.it/loddata/time-interval"]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#formatDate>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_string_sep ;
    rr:objectMap [ rr:constant "/" ]
  ];
].

<#formatDateMapping>
rr:datatype xsd:date ;
fnml:functionValue [
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:array_join ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#yyyysubstring>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#mmsubstring>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#ddsubstring>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_string_sep ;
    rr:objectMap [ rr:constant "-" ]
  ];
].

<#formatDate>
fnml:functionValue [
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:array_join ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#yyyysubstring>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#mmsubstring>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#ddsubstring>
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_string_sep ;
    rr:objectMap [ rr:constant "-" ]
  ];
].

<#yyyysubstring>
fnml:functionValue [
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:string_substring ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate grel:valueParameter ;
    rr:objectMap [ rml:reference "DataCampionamento" ]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:param_int_i_from ;
    rr:objectMap [ rr:constant 6 ]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:param_int_i_opt_to ;
    rr:objectMap [ rr:constant 10 ]
  ]
] .

<#mmsubstring>
fnml:functionValue [
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:string_substring ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate grel:valueParameter ;
    rr:objectMap [ rml:reference "DataCampionamento" ]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:param_int_i_from ;
    rr:objectMap [ rr:constant 3 ]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:param_int_i_opt_to ;
    rr:objectMap [ rr:constant 5 ]
  ]
] .

<#ddsubstring>
fnml:functionValue [
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:string_substring ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate grel:valueParameter ;
    rr:objectMap [ rml:reference "DataCampionamento" ]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:param_int_i_from ;
    rr:objectMap [ rr:constant 0 ]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:param_int_i_opt_to ;
    rr:objectMap [ rr:constant 2 ]
  ]
] .
